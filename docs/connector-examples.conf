# CDC Connector 配置示例

# ============================================
# 示例 1: MySQL → MySQL (默认配置)
# ============================================
mysql-to-mysql {
  cdc {
    task-name = "mysql-to-mysql"
    source-type = "mysql"  # 源数据库类型
    target-type = "mysql"  # 目标数据库类型
    
    source {
      host = "source-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "source_db"
      
      connection-pool {
        max-pool-size = 10
        min-idle = 2
        connection-timeout = 30s
      }
    }
    
    target {
      host = "target-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "target_db"
      
      connection-pool {
        max-pool-size = 20
        min-idle = 5
        connection-timeout = 30s
      }
    }
    
    metadata {
      host = "metadata-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "cdc_metadata"
      
      connection-pool {
        max-pool-size = 5
        min-idle = 1
        connection-timeout = 30s
      }
    }
    
    filter {
      include-databases = ["source_db"]
      exclude-databases = []
      include-table-patterns = ["user_*", "order_*"]
      exclude-table-patterns = ["*_temp", "*_backup"]
    }
    
    parallelism {
      partition-count = 64
      apply-worker-count = 8
      snapshot-worker-count = 4
      batch-size = 100
      flush-interval = 1s
    }
    
    offset {
      store-type = "mysql"
      commit-interval = 5s
      start-from-latest = false
      enable-snapshot = true
    }
  }
}

# ============================================
# 示例 2: MySQL → StarRocks
# ============================================
mysql-to-starrocks {
  cdc {
    task-name = "mysql-to-starrocks"
    source-type = "mysql"
    target-type = "starrocks"
    
    source {
      host = "mysql-host"
      port = 3306
      username = "root"
      password = "password"
      database = "ecommerce"
      
      connection-pool {
        max-pool-size = 10
        min-idle = 2
        connection-timeout = 30s
      }
    }
    
    target {
      # StarRocks FE 节点
      host = "starrocks-fe"
      port = 9030
      username = "root"
      password = "password"
      database = "ecommerce_dw"
      
      connection-pool {
        max-pool-size = 20
        min-idle = 5
        connection-timeout = 30s
      }
    }
    
    metadata {
      host = "metadata-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "cdc_metadata"
      
      connection-pool {
        max-pool-size = 5
        min-idle = 1
        connection-timeout = 30s
      }
    }
    
    filter {
      include-databases = ["ecommerce"]
      exclude-databases = []
      include-table-patterns = ["*"]
      exclude-table-patterns = ["*_log", "*_tmp"]
    }
    
    parallelism {
      partition-count = 128  # StarRocks 可以处理更高并发
      apply-worker-count = 16
      snapshot-worker-count = 8
      batch-size = 500  # StarRocks 批量写入性能更好
      flush-interval = 2s
    }
    
    offset {
      store-type = "mysql"
      commit-interval = 10s
      start-from-latest = false
      enable-snapshot = true
    }
  }
}

# ============================================
# 示例 3: MySQL → MySQL (仅增量同步)
# ============================================
mysql-incremental-only {
  cdc {
    task-name = "mysql-incremental"
    source-type = "mysql"
    target-type = "mysql"
    
    source {
      host = "source-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "app_db"
      
      connection-pool {
        max-pool-size = 5
        min-idle = 1
        connection-timeout = 30s
      }
    }
    
    target {
      host = "target-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "app_db_replica"
      
      connection-pool {
        max-pool-size = 10
        min-idle = 2
        connection-timeout = 30s
      }
    }
    
    metadata {
      host = "metadata-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "cdc_metadata"
      
      connection-pool {
        max-pool-size = 5
        min-idle = 1
        connection-timeout = 30s
      }
    }
    
    filter {
      include-databases = ["app_db"]
      exclude-databases = []
      include-table-patterns = ["*"]
      exclude-table-patterns = []
    }
    
    parallelism {
      partition-count = 32
      apply-worker-count = 4
      snapshot-worker-count = 2
      batch-size = 50
      flush-interval = 1s
    }
    
    offset {
      store-type = "file"
      store-config {
        path = "./data/offsets/mysql-incremental.txt"
      }
      commit-interval = 3s
      start-from-latest = true  # 从最新位置开始，跳过历史数据
      enable-snapshot = false   # 禁用快照，仅增量同步
    }
  }
}

# ============================================
# 示例 4: MySQL → StarRocks (高性能配置)
# ============================================
mysql-to-starrocks-high-perf {
  cdc {
    task-name = "mysql-to-starrocks-hp"
    source-type = "mysql"
    target-type = "starrocks"
    
    source {
      host = "mysql-host"
      port = 3306
      username = "cdc_user"
      password = "cdc_password"
      database = "production"
      
      connection-pool {
        max-pool-size = 20
        min-idle = 5
        connection-timeout = 30s
      }
    }
    
    target {
      host = "starrocks-fe"
      port = 9030
      username = "root"
      password = "password"
      database = "production_dw"
      
      connection-pool {
        max-pool-size = 50  # 更大的连接池
        min-idle = 10
        connection-timeout = 30s
      }
    }
    
    metadata {
      host = "metadata-mysql"
      port = 3306
      username = "root"
      password = "password"
      database = "cdc_metadata"
      
      connection-pool {
        max-pool-size = 10
        min-idle = 2
        connection-timeout = 30s
      }
    }
    
    filter {
      include-databases = ["production"]
      exclude-databases = []
      include-table-patterns = ["*"]
      exclude-table-patterns = ["*_audit", "*_history"]
    }
    
    parallelism {
      partition-count = 256  # 更高的并行度
      apply-worker-count = 32  # 更多的 worker
      snapshot-worker-count = 16
      batch-size = 1000  # 更大的批次
      flush-interval = 5s  # 更长的刷新间隔
    }
    
    offset {
      store-type = "mysql"
      commit-interval = 30s  # 更长的提交间隔
      start-from-latest = false
      enable-snapshot = true
    }
  }
}

# ============================================
# 注意事项
# ============================================

# 1. source-type 和 target-type 必须是已注册的 connector 名称
#    当前支持：
#    - Source: mysql
#    - Sink: mysql, starrocks

# 2. StarRocks 目标配置注意事项：
#    - port 应该是 FE 的 MySQL 协议端口（默认 9030）
#    - 目标表必须是 Primary Key 表模型
#    - 不支持传统事务，使用 Primary Key 保证幂等性

# 3. 性能调优建议：
#    - partition-count: 根据表的主键分布和并发能力调整
#    - batch-size: 根据网络延迟和数据大小调整
#    - flush-interval: 根据延迟要求调整
#    - connection-pool.max-pool-size: 应该 >= apply-worker-count

# 4. 快照配置：
#    - enable-snapshot = true: 先全量同步再增量
#    - enable-snapshot = false: 仅增量同步
#    - start-from-latest = true: 从最新位置开始（跳过历史）
#    - start-from-latest = false: 从头开始（处理所有历史）

# 5. 偏移量存储：
#    - store-type = "mysql": 存储在元数据库（推荐生产环境）
#    - store-type = "file": 存储在本地文件（适合开发测试）
